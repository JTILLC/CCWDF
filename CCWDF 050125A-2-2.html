<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        
function exportDashboardToPDF() {
  try {
    const dashboard = document.getElementById('dashboard');
    if (!dashboard || dashboard.style.display === 'none') {
      alert('Please open the Dashboard before exporting.');
      return;
    }

    const clone = dashboard.cloneNode(true);
    const win = window.open('', '_blank');
    if (!win) throw new Error('Failed to open new window');

    const html = '<html><head><title>Ishida Dashboard Report</title>' +
      '<style>' +
      'body { font-family: Arial, sans-serif; padding: 20px; }' +
      'table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }' +
      'th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }' +
      'h3, h4 { text-align: center; }' +
      '</style></head><body>' +
      '<h1>Ishida Dashboard Report</h1>' +
      clone.innerHTML +
      '</body></html>';

    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
    win.close();
  } catch (error) {
    console.error('Error in exportDashboardToPDF:', error);
    alert('Error exporting dashboard: ' + error.message);
  }
}

</script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ishida Weigher Issue Logger</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    select, input[type="text"], input[type="number"] {
      width: 90%;
    }
    h1, h3 {
      text-align: center;
    }
    .machine-section, .dashboard {
      display: none;
      border: 2px solid #aaa;
      padding: 10px;
      margin-top: 20px;
      background-color: #fff;
    }
    .nav-buttons {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .nav-buttons button {
      margin-right: 10px;
    }
    .machine-running {
      margin-bottom: 10px;
      font-weight: bold;
    }
    .notes-container {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .save-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #4caf50;
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      display: none;
    }
    .global-fields {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .global-fields label {
      margin-right: 5px;
    }
    .line-fields {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .line-fields label {
      margin-right: 5px;
    }
    .dashboard table {
      margin-top: 10px;
    }
    .dashboard h3 {
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      th {
        display: none;
      }
      td {
        display: flex;
        justify-content: space-between;
        padding: 5px;
      }
      td::before {
        content: attr(data-label);
        font-weight: bold;
        width: 50%;
      }
      select, input[type="text"], input[type="number"] {
        width: 100%;
      }
      .global-fields, .line-fields {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>Ishida Weigher (CCW) Issue Logger</h1>
  <div class="global-fields">
    <label for="customer">Customer:</label>
    <input type="text" id="customer" oninput="debounceSave()">
    <label for="address">Address:</label>
    <input type="text" id="address" oninput="debounceSave()">
    <label for="cityState">City/State:</label>
    <input type="text" id="cityState" oninput="debounceSave()">
  </div>
  <label for="headCount">Number of Heads:</label>
  <select id="headCount" onchange="debounceSave()">
    <option value="10">10</option>
    <option value="14">14</option>
    <option value="16">16</option>
    <option value="18">18</option>
    <option value="20">20</option>
    <option value="24">24</option>
    <option value="28">28</option>
    <option value="32">32</option>
  </select>
  <button onclick="addLine()" aria-label="Add a new line">Add Line</button>
  <button onclick="exportToCSV()">Export Current Line to CSV</button>
  <button onclick="exportToJSON()">Export All to JSON</button>
  <button onclick="exportToPDF()">Export to PDF</button>
<button onclick="exportDashboardToPDF()">Export Dashboard to PDF</button>
  <input type="file" id="importFile" accept=".csv,.json" onchange="handleImport(event)">
  <button onclick="clearLocalStorage()" aria-label="Clear local storage">Clear Local Storage</button>
  <button onclick="showDashboard()" aria-label="Show dashboard">Show Dashboard</button>
  <div class="save-indicator" id="saveIndicator">Data Saved</div>
  <div class="nav-buttons" id="machineNav"></div>
  <div id="machineContainer"></div>
  <div id="dashboard" class="dashboard"></div>
  <script>
    // Global error handler for uncaught exceptions
    window.onerror = function(message, source, lineno, colno, error) {
      console.error(`Uncaught error: ${message} at ${source}:${lineno}:${colno}`, error);
      alert(`Unexpected error: ${message}. Please check the console for details.`);
    };

    // Debounce utility for saveToLocalStorage
    let saveTimeout = null;
    function debounceSave() {
      try {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          saveToLocalStorage();
          showSaveIndicator();
        }, 300);
      } catch (error) {
        console.error('Error in debounceSave:', error);
      }
    }

    function showSaveIndicator() {
      try {
        const indicator = document.getElementById('saveIndicator');
        if (indicator) {
          indicator.style.display = 'block';
          setTimeout(() => {
            indicator.style.display = 'none';
          }, 1000);
        }
      } catch (error) {
        console.error('Error in showSaveIndicator:', error);
      }
    }

    function addLine() {
      try {
        const headCountSelect = document.getElementById("headCount");
        const count = parseInt(headCountSelect?.value);
        if (isNaN(count) || ![10, 14, 16, 18, 20, 24, 28, 32].includes(count)) {
          throw new Error('Invalid head count');
        }
        const container = document.getElementById("machineContainer");
        const nav = document.getElementById("machineNav");
        if (!container || !nav) throw new Error('Missing container or nav elements');
        const machineId = `machine_${document.querySelectorAll('.machine-section').length + 1}`;

        const navButton = document.createElement("button");
        navButton.textContent = `Line ${document.querySelectorAll('.machine-section').length + 1}`;
        navButton.id = `nav_${machineId}`;
        navButton.onclick = () => showLine(machineId);
        navButton.setAttribute('aria-label', `Show ${navButton.textContent}`);

        const removeButton = document.createElement("button");
        removeButton.textContent = "âœ–";
        removeButton.style.marginLeft = "5px";
        removeButton.setAttribute('aria-label', `Remove ${navButton.textContent}`);
        removeButton.onclick = function(event) {
          try {
            event.stopPropagation();
            console.debug(`Attempting to remove line: ${machineId}`);
            if (confirm(`Are you sure you want to remove ${navButton.textContent}?`)) {
              const section = document.getElementById(machineId);
              if (section) section.remove();
              navButton.remove();
              removeButton.remove();
              debounceSave();
              console.debug(`Line ${machineId} removed successfully`);
              updateDashboard();
            }
          } catch (error) {
            console.error(`Error removing line ${machineId}:`, error);
            alert(`Error removing line: ${error.message}`);
          }
        };

        nav.appendChild(navButton);
        nav.appendChild(removeButton);

        const machineSection = document.createElement("div");
        machineSection.className = "machine-section";
        machineSection.id = machineId;

        let rows = '';
        for (let i = 0; i < count; i++) {
          const index = i + 1;
          rows += `
            <tr>
              <td data-label="Head #">${index}</td>
              <td data-label="Status"><select name="status_${machineId}_${index}" onchange="updateRowColors(); debounceSave(); updateDashboard()">
                <option value="active">Active</option>
                <option value="offline">Offline</option>
              </select></td>
              <td data-label="Error"><select name="error_${machineId}_${index}" onchange="debounceSave(); updateDashboard()">
                <option value="None">None</option>
                <option value="Chute">Chute</option>
                <option value="Operator">Operator</option>
                <option value="Load Cell">Load Cell</option>
                <option value="Detached Head">Detached Head</option>
                <option value="Stepper Motor Error">Stepper Motor Error</option>
                <option value="Hopper Issues">Hopper Issues</option>
                <option value="Installed Wrong">Installed Wrong</option>
                <option value="Other">Other</option>
              </select></td>
              <td data-label="Notes"><input type="text" name="custom_${machineId}_${index}" oninput="debounceSave(); updateDashboard()"></td>
              <td data-label="Fixed"><select name="fixed_${machineId}_${index}" onchange="updateRowColors(); debounceSave(); updateDashboard()">
                <option value="na">N/A</option>
                <option value="not_fixed">Not Fixed</option>
                <option value="fixed">Fixed</option>
              </select></td>
            </tr>`;
        }

        machineSection.innerHTML = `
          <h2 contenteditable="true" oninput="updateLineName('${machineId}', this.textContent); debounceSave(); updateDashboard()">${navButton.textContent}</h2>
          <div class="line-fields">
            <label for="model_${machineId}">Model:</label>
            <input type="text" id="model_${machineId}" oninput="debounceSave()">
            <label for="jobNumber_${machineId}">Job Number:</label>
            <input type="text" id="jobNumber_${machineId}" oninput="debounceSave()">
            <label for="serialNumber_${machineId}">Serial Number:</label>
            <input type="text" id="serialNumber_${machineId}" oninput="debounceSave()">
          </div>
          <form id="issueForm_${machineId}">
            <div class="machine-running">
              <label><input type="checkbox" name="running_${machineId}" onchange="debounceSave()"> Line Running?</label>
            </div>
            <table>
              <thead>
                <tr><th>Head #</th><th>Status</th><th>Error</th><th>Notes</th><th>Fixed</th></tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
            <label><input type="checkbox" id="spanAdjust_${machineId}" onchange="toggleSpanAdjust(this, '${machineId}', ${count}); debounceSave()"> Span Adjust</label>
            <div id="spanAdjustTable_${machineId}" style="display: none; margin-top: 10px;"></div>
            <div class="notes-container">
              <label for="notes_${machineId}"><strong>Notes:</strong></label>
              <textarea id="notes_${machineId}" name="notes_${machineId}" rows="4" style="width: 100%;" oninput="debounceSave()"></textarea>
              <button type="button" onclick="addTimestamp('${machineId}')" aria-label="Add timestamp to notes">Add Timestamp</button>
            </div>
          </form>`;

        container.appendChild(machineSection);
        showLine(machineId);
        updateRowColors();
        debounceSave();
        updateDashboard();
      } catch (error) {
        console.error('Error in addLine:', error);
        alert(`Error adding line: ${error.message}`);
      }
    }

    function showLine(id) {
      try {
        document.querySelectorAll('.machine-section, .dashboard').forEach(s => s.style.display = 'none');
        const section = document.getElementById(id);
        if (!section) throw new Error(`Section ${id} not found`);
        section.style.display = 'block';
      } catch (error) {
        console.error('Error in showLine:', error);
      }
    }

    function showDashboard() {
      try {
        console.debug('Showing dashboard');
        document.querySelectorAll('.machine-section, .dashboard').forEach(s => s.style.display = 'none');
        const dashboard = document.getElementById('dashboard');
        if (!dashboard) throw new Error('Dashboard element not found');
        updateDashboard();
        dashboard.style.display = 'block';
      } catch (error) {
        console.error('Error in showDashboard:', error);
        alert(`Error showing dashboard: ${error.message}`);
      }
    }

    function updateDashboard() {
      try {
        console.debug('Updating dashboard');
        const dashboard = document.getElementById('dashboard');
        if (!dashboard) throw new Error('Dashboard element not found');
        const sections = document.querySelectorAll('.machine-section');
        let html = '<h3>Dashboard: Offline Heads</h3>';
        let hasOfflineHeads = false;

        if (sections.length === 0) {
          html += '<p>No lines added yet.</p>';
        } else {
          sections.forEach(section => {
            const title = section.querySelector('h2')?.textContent.trim() || 'Untitled';
            const mainTable = section.querySelector('form table tbody');
            if (!mainTable) {
              console.warn('Main table not found for section:', section);
              return;
            }
            let lineHtml = '';
            Array.from(mainTable.querySelectorAll('tr')).forEach(row => {
              const headNum = row.querySelector('td:first-child')?.textContent || '';
              const statusSelect = row.querySelector('select[name^="status_"]');
              const errorSelect = row.querySelector('select[name^="error_"]');
              const fixedSelect = row.querySelector('select[name^="fixed_"]');
              const notesInput = row.querySelector('input[name^="custom_"]');
              const status = statusSelect?.value || 'active';
              if (status !== 'offline') return;
              const reason = errorSelect?.value || 'None';
              const fixed = fixedSelect?.value || 'na';
              const notes = notesInput?.value || '';
              const rowStyle = fixed === 'fixed' ? 'background-color: orange;' : 'background-color: lightcoral;';
              lineHtml += `
                <tr style="${rowStyle}">
                  <td data-label="Head #">${headNum}</td>
                  <td data-label="Status">Offline</td>
                  <td data-label="Reason">${reason.replace(/</g, '<')}</td>
                  <td data-label="Fixed">${fixed === 'fixed' ? 'Fixed' : fixed === 'not_fixed' ? 'Not Fixed' : 'N/A'}</td>
                  <td data-label="Notes">${notes.replace(/</g, '<')}</td>
                </tr>`;
              hasOfflineHeads = true;
            });
            if (lineHtml) {
              html += `<h4>${title}</h4>`;
              html += '<table><thead><tr><th>Head #</th><th>Status</th><th>Reason</th><th>Fixed</th><th>Notes</th></tr></thead><tbody>';
              html += lineHtml;
              html += '</tbody></table>';
            }
          });
        }

        if (!hasOfflineHeads && sections.length > 0) {
          html += '<p>No offline heads.</p>';
        }
        dashboard.innerHTML = html;
        console.debug('Dashboard updated successfully');
      } catch (error) {
        console.error('Error in updateDashboard:', error);
        alert(`Error updating dashboard: ${error.message}`);
      }
    }

    function updateLineName(machineId, newName) {
      try {
        const navButton = document.getElementById(`nav_${machineId}`);
        if (!navButton) throw new Error(`Nav button for ${machineId} not found`);
        navButton.textContent = newName;
        navButton.setAttribute('aria-label', `Show ${newName}`);
        updateDashboard();
      } catch (error) {
        console.error('Error in updateLineName:', error);
      }
    }

    function toggleCustomError(selectEl) {
      // No-op, kept for future extensibility
    }

    function updateRowColors() {
      try {
        document.querySelectorAll(".machine-section tbody tr").forEach(row => {
          const statusSelect = row.querySelector("select[name^='status']");
          const fixedSelect = row.querySelector("select[name^='fixed']");
          const status = statusSelect?.value;
          const fixed = fixedSelect?.value;
          row.style.backgroundColor = "";
          if (fixed === "fixed") row.style.backgroundColor = "orange";
          else if (status === "active") row.style.backgroundColor = "lightgreen";
          else if (status === "offline") row.style.backgroundColor = "lightcoral";
        });
      } catch (error) {
        console.error('Error in updateRowColors:', error);
      }
    }

    function toggleSpanAdjust(checkbox, machineId, count) {
      try {
        console.debug(`Toggling span adjust for ${machineId}, checked: ${checkbox.checked}`);
        const container = document.getElementById(`spanAdjustTable_${machineId}`);
        if (!container) throw new Error(`Span adjust container not found for ${machineId}`);
        if (checkbox.checked) {
          container.innerHTML = '';
          let html = '<table><thead><tr><th>Head #</th><th>Current Weight</th><th>Span Weight</th><th>Difference</th></tr></thead><tbody>';
          for (let i = 1; i <= count; i++) {
            html += `<tr>
              <td>${i}</td>
              <td><input type='number' step='any' oninput='updateDifference(this, "${machineId}", ${i}); debounceSave()' id='cur_${machineId}_${i}'></td>
              <td><input type='number' step='any' oninput='updateDifference(this, "${machineId}", ${i}); debounceSave()' id='span_${machineId}_${i}'></td>
              <td><span id='diff_${machineId}_${i}'></span></td>
            </tr>`;
          }
          html += '</tbody></table>';
          container.innerHTML = html;
          container.style.display = 'block';
        } else {
          console.debug(`Prompting to clear span adjust for ${machineId}`);
          const confirmClear = confirm("Are you sure you want to hide and clear Span Adjust data?");
          if (confirmClear) {
            container.innerHTML = '';
            container.style.display = 'none';
            checkbox.checked = false;
            console.debug(`Span adjust cleared for ${machineId}`);
          } else {
            checkbox.checked = true;
            console.debug(`Span adjust clear canceled for ${machineId}`);
          }
        }
        debounceSave();
      } catch (error) {
        console.error('Error in toggleSpanAdjust:', error);
        alert(`Error toggling span adjust: ${error.message}`);
      }
    }

    function updateDifference(input, machineId, index) {
      try {
        const curInput = document.getElementById(`cur_${machineId}_${index}`);
        const spanInput = document.getElementById(`span_${machineId}_${index}`);
        const diffSpan = document.getElementById(`diff_${machineId}_${index}`);
        if (!curInput || !spanInput || !diffSpan) throw new Error(`Missing elements for difference update: ${machineId}_${index}`);
        const curVal = parseFloat(curInput.value) || 0;
        const spanVal = parseFloat(spanInput.value) || 0;
        const diff = spanVal - curVal;
        diffSpan.textContent = diff.toFixed(2);
      } catch (error) {
        console.error('Error in updateDifference:', error);
      }
    }

    function addTimestamp(machineId) {
      try {
        console.debug(`Adding timestamp for machineId: ${machineId}`);
        const textarea = document.getElementById(`notes_${machineId}`);
        if (!textarea) throw new Error(`Notes textarea not found for ${machineId}`);
        const now = new Date().toLocaleString('en-US', { timeZone: 'America/Denver' });
        const timestamp = `[${now}] `;
        const currentValue = textarea.value || '';
        const cursorPos = textarea.selectionStart ?? currentValue.length;
        console.debug(`Cursor position: ${cursorPos}, Current value length: ${currentValue.length}`);
        const textBefore = currentValue.substring(0, cursorPos);
        const textAfter = currentValue.substring(cursorPos);
        textarea.value = textBefore + timestamp + textAfter;
        const newCursorPos = cursorPos + timestamp.length;
        textarea.selectionStart = textarea.selectionEnd = newCursorPos;
        textarea.focus();
        debounceSave();
      } catch (error) {
        console.error('Error in addTimestamp:', error);
        alert(`Error adding timestamp: ${error.message}`);
      }
    }

    function clearLocalStorage() {
      try {
        console.debug('Attempting to clear localStorage');
        if (confirm('Are you sure you want to clear all saved data? This will reset the application.')) {
          localStorage.removeItem('ishidaLogger');
          console.debug('localStorage cleared');
          setTimeout(() => {
            location.reload();
            console.debug('Page reloaded after clearing localStorage');
          }, 0);
        }
      } catch (error) {
        console.error('Error in clearLocalStorage:', error);
        alert(`Error clearing local storage: ${error.message}`);
      }
    }

    function saveToLocalStorage() {
      try {
        console.debug('Saving to localStorage');
        const customer = document.getElementById('customer')?.value || '';
        const address = document.getElementById('address')?.value || '';
        const cityState = document.getElementById('cityState')?.value || '';
        const headCount = document.getElementById('headCount')?.value || '14';
        const lines = Array.from(document.querySelectorAll('.machine-section')).map(section => {
          const title = section.querySelector('h2')?.textContent.trim() || '';
          const model = section.querySelector(`#model_${section.id}`)?.value || '';
          const jobNumber = section.querySelector(`#jobNumber_${section.id}`)?.value || '';
          const serialNumber = section.querySelector(`#serialNumber_${section.id}`)?.value || '';
          const running = section.querySelector('input[name^="running_"]')?.checked || false;
          const notes = section.querySelector('textarea')?.value || '';
          const spanAdjustSection = section.querySelector(`[id^="spanAdjustTable_"]`);
          const spanAdjustData = spanAdjustSection && spanAdjustSection.style.display !== 'none'
            ? Array.from(spanAdjustSection.querySelectorAll('tbody tr')).map(row => {
                const headNum = parseInt(row.querySelector('td:first-child')?.textContent) || 0;
                const inputs = row.querySelectorAll('input');
                const current = inputs[0] ? parseFloat(inputs[0].value) || 0 : 0;
                const span = inputs[1] ? parseFloat(inputs[1].value) || 0 : 0;
                return {
                  head: headNum,
                  current: current,
                  span: span,
                  diff: (span - current).toFixed(2)
                };
              })
            : [];
          const mainTable = section.querySelector('form table tbody');
          if (!mainTable) {
            console.warn('Main table not found for section:', section);
            return null;
          }
          const rows = Array.from(mainTable.querySelectorAll('tr')).map(row => {
            const cells = row.querySelectorAll('select, input[type="text"]');
            if (cells.length < 4) {
              console.warn('Invalid row structure:', row);
              return null;
            }
            const headNum = row.querySelector('td:first-child')?.textContent || '';
            const spanAdjust = spanAdjustData.find(sa => sa.head === parseInt(headNum)) || {};
            return {
              status: cells[0].value || 'active',
              error: cells[1].value || 'None',
              customError: cells[2].value || '',
              fixed: cells[3].value || 'na',
              currentWeight: spanAdjust.current !== undefined ? spanAdjust.current : 0,
              spanWeight: spanAdjust.span !== undefined ? spanAdjust.span : 0,
              weightDifference: spanAdjust.diff !== undefined ? parseFloat(spanAdjust.diff) : 0
            };
          }).filter(row => row);
          return { title, model, jobNumber, serialNumber, running, notes, rows };
        }).filter(line => line);

        const data = { customer, address, cityState, headCount, lines };
        try {
          localStorage.setItem('ishidaLogger', JSON.stringify(data));
          console.debug('localStorage saved successfully');
        } catch (storageError) {
          if (storageError.name === 'QuotaExceededError') {
            console.warn('Local storage quota exceeded. Clearing old data.');
            localStorage.removeItem('ishidaLogger');
            localStorage.setItem('ishidaLogger', JSON.stringify({ ...data, lines: data.lines.slice(-10) }));
            alert('Storage limit reached. Older data was cleared to save new changes. Consider exporting to JSON as a backup.');
          } else {
            throw storageError;
          }
        }
      } catch (error) {
        console.error('Error in saveToLocalStorage:', error);
        alert(`Error saving data: ${error.message}. Please export to JSON to avoid data loss.`);
      }
    }

    function loadFromLocalStorage() {
      try {
        console.debug('Loading from localStorage');
        const data = localStorage.getItem('ishidaLogger');
        if (!data) {
          console.debug('No localStorage data found');
          return;
        }
        const parsed = JSON.parse(data);
        if (!parsed || typeof parsed !== 'object') {
          console.warn('Invalid localStorage data format');
          return;
        }
        const { customer, address, cityState, headCount, lines } = parsed;
        if (customer) document.getElementById('customer').value = customer;
        if (address) document.getElementById('address').value = address;
        if (cityState) document.getElementById('cityState').value = cityState;
        if (headCount && document.getElementById('headCount').querySelector(`option[value="${headCount}"]`)) {
          document.getElementById('headCount').value = headCount;
        }
        if (!Array.isArray(lines)) {
          console.warn('Invalid lines data format');
          return;
        }
        lines.forEach(line => {
          if (!line?.rows || !line?.title) {
            console.warn('Skipping invalid line data:', line);
            return;
          }
          const headCountInput = document.getElementById('headCount');
          if (headCountInput) headCountInput.value = line.rows.length;
          addLine();
          const section = document.querySelector('.machine-section:last-of-type');
          if (!section) {
            console.warn('No section created for line:', line.title);
            return;
          }
          const titleEl = section.querySelector('h2');
          if (titleEl) titleEl.textContent = line.title;
          const modelInput = section.querySelector(`#model_${section.id}`);
          if (modelInput) modelInput.value = line.model || '';
          const jobNumberInput = section.querySelector(`#jobNumber_${section.id}`);
          if (jobNumberInput) jobNumberInput.value = line.jobNumber || '';
          const serialNumberInput = section.querySelector(`#serialNumber_${section.id}`);
          if (serialNumberInput) serialNumberInput.value = line.serialNumber || '';
          const runningCheckbox = section.querySelector('input[name^="running_"]');
          if (runningCheckbox) runningCheckbox.checked = line.running;
          const notesTextarea = section.querySelector('textarea');
          if (notesTextarea) notesTextarea.value = line.notes || '';
          const rows = section.querySelectorAll('tbody tr');
          line.rows.forEach((row, i) => {
            if (rows[i]) {
              const cells = rows[i].querySelectorAll('select, input');
              if (cells.length >= 4) {
                cells[0].value = row.status || 'active';
                cells[1].value = row.error || 'None';
                cells[2].value = row.customError || '';
                cells[3].value = row.fixed || 'na';
              }
            }
          });
          updateRowColors();
          if (line.rows.some(row => row.currentWeight || row.spanWeight || row.weightDifference)) {
            const checkbox = section.querySelector('input[id^="spanAdjust_"]');
            if (checkbox) {
              checkbox.checked = true;
              toggleSpanAdjust(checkbox, section.id, line.rows.length);
              line.rows.forEach((row, i) => {
                const head = i + 1;
                const curInput = document.getElementById(`cur_${section.id}_${head}`);
                const spanInput = document.getElementById(`span_${section.id}_${head}`);
                if (curInput && spanInput) {
                  curInput.value = row.currentWeight || '';
                  spanInput.value = row.spanWeight || '';
                  updateDifference(null, section.id, head);
                }
              });
            }
          }
        });
        console.debug('localStorage loaded successfully');
        updateDashboard();
      } catch (error) {
        console.error('Error in loadFromLocalStorage:', error);
        alert(`Error loading data: ${error.message}. Please import a JSON backup if available.`);
      }
    }

    function exportToCSV() {
      try {
        const section = document.querySelector('.machine-section:not([style*="display: none"])');
        if (!section) {
          alert('No line is currently visible to export.');
          return;
        }

        const customer = document.getElementById('customer')?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const address = document.getElementById('address')?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const cityState = document.getElementById('cityState')?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const title = section.querySelector('h2')?.textContent.trim() || 'Untitled';
        const model = section.querySelector(`#model_${section.id}`)?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const jobNumber = section.querySelector(`#jobNumber_${section.id}`)?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const serialNumber = section.querySelector(`#serialNumber_${section.id}`)?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const running = section.querySelector('input[name^="running_"]')?.checked ? 'Yes' : 'No';
        const notes = section.querySelector('textarea')?.value.replace(/\n/g, ' ').replace(/"/g, '""') || '';
        const spanAdjustSection = section.querySelector(`[id^="spanAdjustTable_"]`);
        const spanAdjustData = spanAdjustSection && spanAdjustSection.style.display !== 'none'
          ? Array.from(spanAdjustSection.querySelectorAll('tbody tr')).map(row => {
              const headNum = parseInt(row.querySelector('td:first-child')?.textContent) || 0;
              const inputs = row.querySelectorAll('input');
              const current = inputs[0] ? parseFloat(inputs[0].value) || 0 : 0;
              const span = inputs[1] ? parseFloat(inputs[1].value) || 0 : 0;
              return {
                head: headNum,
                current: current,
                span: span,
                diff: (span - current).toFixed(2)
              };
            })
          : [];

        const mainTable = section.querySelector('form table tbody');
        if (!mainTable) throw new Error('Main table not found');
        const headers = ['Head #', 'Status', 'Error', 'Notes', 'Fixed', 'Current Weight', 'Span Weight', 'Weight Difference']
          .map(h => `"${h}"`).join(',');
        const rows = Array.from(mainTable.querySelectorAll('tr')).map(row => {
          const cells = row.querySelectorAll('select, input[type="text"]');
          if (cells.length < 4) {
            console.warn('Invalid row structure:', row);
            return '';
          }
          const headNum = row.querySelector('td:first-child')?.textContent || '';
          const spanAdjust = spanAdjustData.find(sa => sa.head === parseInt(headNum)) || {};
          return [
            headNum,
            cells[0].value || 'active',
            cells[1].value || 'None',
            cells[2].value.replace(/"/g, '""') || '',
            cells[3].value || 'na',
            spanAdjust.current !== undefined ? spanAdjust.current : '',
            spanAdjust.span !== undefined ? spanAdjust.span : '',
            spanAdjust.diff !== undefined ? spanAdjust.diff : ''
          ].map(v => `"${v}"`).join(',');
        }).filter(row => row).join('\n');

        const csvContent = [
          `"Customer","${customer}"`,
          `"Address","${address}"`,
          `"City/State","${cityState}"`,
          `"Line Title","${title}"`,
          `"Model","${model}"`,
          `"Job Number","${jobNumber}"`,
          `"Serial Number","${serialNumber}"`,
          `"Running","${running}"`,
          `"Line Notes","${notes}"`,
          '',
          headers,
          rows
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `IshidaIssueLog_${title.replace(/\s+/g, '_')}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Error in exportToCSV:', error);
        alert(`Error exporting to CSV: ${error.message}`);
      }
    }

    function exportToJSON() {
      try {
        const customer = document.getElementById('customer')?.value || '';
        const address = document.getElementById('address')?.value || '';
        const cityState = document.getElementById('cityState')?.value || '';
        const headCount = document.getElementById('headCount')?.value || '14';
        const lines = Array.from(document.querySelectorAll('.machine-section')).map(section => {
          const title = section.querySelector('h2')?.textContent.trim() || 'Untitled';
          const model = section.querySelector(`#model_${section.id}`)?.value || '';
          const jobNumber = section.querySelector(`#jobNumber_${section.id}`)?.value || '';
          const serialNumber = section.querySelector(`#serialNumber_${section.id}`)?.value || '';
          const running = section.querySelector('input[name^="running_"]')?.checked || false;
          const notes = section.querySelector('textarea')?.value || '';
          const spanAdjustSection = section.querySelector(`[id^="spanAdjustTable_"]`);
          const spanAdjustData = spanAdjustSection && spanAdjustSection.style.display !== 'none'
            ? Array.from(spanAdjustSection.querySelectorAll('tbody tr')).map(row => {
                const headNum = parseInt(row.querySelector('td:first-child')?.textContent) || 0;
                const inputs = row.querySelectorAll('input');
                const current = inputs[0] ? parseFloat(inputs[0].value) || 0 : 0;
                const span = inputs[1] ? parseFloat(inputs[1].value) || 0 : 0;
                return {
                  head: headNum,
                  current: current,
                  span: span,
                  diff: (span - current).toFixed(2)
                };
              })
            : [];

          const mainTable = section.querySelector('form table tbody');
          if (!mainTable) {
            console.warn('Main table not found for JSON export:', title);
            return null;
          }
          const rows = Array.from(mainTable.querySelectorAll('tr')).map(row => {
            const cells = row.querySelectorAll('select, input[type="text"]');
            if (cells.length < 4) {
              console.warn('Invalid row structure:', row);
              return null;
            }
            const headNum = row.querySelector('td:first-child')?.textContent || '';
            const spanAdjust = spanAdjustData.find(sa => sa.head === parseInt(headNum)) || {};
            return {
              status: cells[0].value || 'active',
              error: cells[1].value || 'None',
              customError: cells[2].value || '',
              fixed: cells[3].value || 'na',
              currentWeight: spanAdjust.current !== undefined ? spanAdjust.current : 0,
              spanWeight: spanAdjust.span !== undefined ? spanAdjust.span : 0,
              weightDifference: spanAdjust.diff !== undefined ? parseFloat(spanAdjust.diff) : 0
            };
          }).filter(row => row);

          return { title, model, jobNumber, serialNumber, running, notes, rows };
        }).filter(line => line);

        const data = { customer, address, cityState, headCount, lines };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'IshidaIssueLog.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error('Error in exportToJSON:', error);
        alert(`Error exporting to JSON: ${error.message}`);
      }
    }

    function handleImport(event) {
      try {
        const file = event.target.files?.[0];
        if (!file) {
          console.warn('No file selected for import');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            if (file.name.endsWith('.json')) {
              const data = JSON.parse(e.target.result);
              if (!data || typeof data !== 'object') throw new Error('Invalid JSON format');
              const { customer, address, cityState, headCount, lines } = data;
              if (customer) document.getElementById('customer').value = customer;
              if (address) document.getElementById('address').value = address;
              if (cityState) document.getElementById('cityState').value = cityState;
              if (headCount && document.getElementById('headCount').querySelector(`option[value="${headCount}"]`)) {
                document.getElementById('headCount').value = headCount;
              }
              if (!Array.isArray(lines)) throw new Error('Invalid lines data format');
              lines.forEach(line => {
                if (!line?.rows || !line?.title) {
                  console.warn('Skipping invalid line data:', line);
                  return;
                }
                const headCountInput = document.getElementById('headCount');
                if (headCountInput) headCountInput.value = line.rows.length;
                addLine();
                const section = document.querySelector('.machine-section:last-of-type');
                if (!section) {
                  console.warn('No section created for import:', line.title);
                  return;
                }
                const titleEl = section.querySelector('h2');
                if (titleEl) titleEl.textContent = line.title;
                const modelInput = section.querySelector(`#model_${section.id}`);
                if (modelInput) modelInput.value = line.model || '';
                const jobNumberInput = section.querySelector(`#jobNumber_${section.id}`);
                if (jobNumberInput) jobNumberInput.value = line.jobNumber || '';
                const serialNumberInput = section.querySelector(`#serialNumber_${section.id}`);
                if (serialNumberInput) serialNumberInput.value = line.serialNumber || '';
                const runningCheckbox = section.querySelector('input[name^="running_"]');
                if (runningCheckbox) runningCheckbox.checked = line.running;
                const notesTextarea = section.querySelector('textarea');
                if (notesTextarea) notesTextarea.value = line.notes || '';
                const rows = section.querySelectorAll('tbody tr');
                line.rows.forEach((row, i) => {
                  if (rows[i]) {
                    const cells = rows[i].querySelectorAll('select, input');
                    if (cells.length >= 4) {
                      cells[0].value = row.status || 'active';
                      cells[1].value = row.error || 'None';
                      cells[2].value = row.customError || '';
                      cells[3].value = row.fixed || 'na';
                    }
                  }
                });
                updateRowColors();
                if (line.rows.some(row => row.currentWeight || row.spanWeight || row.weightDifference)) {
                  const checkbox = section.querySelector('input[id^="spanAdjust_"]');
                  if (checkbox) {
                    checkbox.checked = true;
                    toggleSpanAdjust(checkbox, section.id, line.rows.length);
                    line.rows.forEach((row, i) => {
                      const head = i + 1;
                      const curInput = document.getElementById(`cur_${section.id}_${head}`);
                      const spanInput = document.getElementById(`span_${section.id}_${head}`);
                      if (curInput && spanInput) {
                        curInput.value = row.currentWeight || '';
                        spanInput.value = row.spanWeight || '';
                        updateDifference(null, section.id, head);
                      }
                    });
                  }
                }
              });
              updateDashboard();
            }
          } catch (error) {
            console.error('Error parsing import data:', error);
            alert(`Error importing file: ${error.message}`);
          }
        };
        reader.readAsText(file);
      } catch (error) {
        console.error('Error in handleImport:', error);
        alert(`Error initiating import: ${error.message}`);
      }
    }

    function exportToPDF() {
      try {
        const visible = document.querySelector('.machine-section:not([style*="display: none"])');
        if (!visible) {
          alert('No line is currently visible to export.');
          return;
        }
        const customer = document.getElementById('customer')?.value || '';
        const address = document.getElementById('address')?.value || '';
        const cityState = document.getElementById('cityState')?.value || '';
        const clone = visible.cloneNode(true);

        clone.querySelectorAll('select').forEach(select => {
          const span = document.createElement('span');
          span.textContent = select.options[select.selectedIndex]?.textContent || '';
          select.replaceWith(span);
        });
        clone.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
          const span = document.createElement('span');
          span.textContent = input.value || '';
          input.replaceWith(span);
        });
        clone.querySelectorAll('textarea').forEach(textarea => {
          const div = document.createElement('div');
          div.textContent = textarea.value || '';
          textarea.replaceWith(div);
        });
        clone.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          const span = document.createElement('span');
          span.textContent = checkbox.checked ? 'Yes' : 'No';
          checkbox.replaceWith(span);
        });

        const spanAdjust = clone.querySelector('[id^="spanAdjustTable_"]');
        if (spanAdjust && spanAdjust.style.display !== 'none') {
          spanAdjust.querySelectorAll('span[id^="diff_"]').forEach(diff => {
            diff.textContent = diff.textContent || '0.00';
          });
        }

        const win = window.open('', '_blank');
        if (!win) throw new Error('Failed to open new window');
        win.document.write(`
          <html>
            <head>
              <title>Ishida Issue Log</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
                h2 { text-align: center; }
                div { margin-bottom: 10px; }
                .global-fields, .line-fields { margin-bottom: 10px; }
              </style>
            </head>
            <body>
              <div class="global-fields">
                <div><strong>Customer:</strong> ${customer.replace(/</g, '<')}</div>
                <div><strong>Address:</strong> ${address.replace(/</g, '<')}</div>
                <div><strong>City/State:</strong> ${cityState.replace(/</g, '<')}</div>
              </div>
              ${clone.innerHTML}
            </body>
          </html>
        `);
        win.document.close();
        win.focus();
        win.print();
        win.close();
      } catch (error) {
        console.error('Error in exportToPDF:', error);
        alert(`Error exporting to PDF: ${error.message}`);
      }
    }

    window.onload = function() {
      try {
        console.debug('Loading from localStorage on page load');
        loadFromLocalStorage();
      } catch (error) {
        console.error('Error in window.onload:', error);
        alert(`Error loading data: ${error.message}. Please import a JSON backup if available.`);
      }
    };
  
function exportDashboardToPDF() {
  try {
    const dashboard = document.getElementById('dashboard');
    if (!dashboard || dashboard.style.display === 'none') {
      alert('Please open the Dashboard before exporting.');
      return;
    }

    const clone = dashboard.cloneNode(true);
    const win = window.open('', '_blank');
    if (!win) throw new Error('Failed to open new window');

    const html = '<html><head><title>Ishida Dashboard Report</title>' +
      '<style>' +
      'body { font-family: Arial, sans-serif; padding: 20px; }' +
      'table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }' +
      'th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }' +
      'h3, h4 { text-align: center; }' +
      '</style></head><body>' +
      '<h1>Ishida Dashboard Report</h1>' +
      clone.innerHTML +
      '</body></html>';

    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
    win.close();
  } catch (error) {
    console.error('Error in exportDashboardToPDF:', error);
    alert('Error exporting dashboard: ' + error.message);
  }
}

</script>
</body>
</html>
